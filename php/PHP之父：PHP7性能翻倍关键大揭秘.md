## PHP之父：PHP7性能翻倍关键大揭秘

### 目录

- [PHP之父：PHP7性能翻倍关键大揭秘](#php之父php7性能翻倍关键大揭秘)
    
    - [PHP之父：PHP7 性能翻倍关键大揭秘](#php之父php7-性能翻倍关键大揭秘)
    - [受HHVM刺激，决定打造兼具性能与功能的PHP](#受hhvm刺激决定打造兼具性能与功能的php)
    - [非强型别语言的PHP，导入JIT是难上加难](#非强型别语言的php导入jit是难上加难)



> 20岁老牌网页程序语言PHP，最快将在10月底释出PHP 7新版，这是十年来的首次大改版，最大特色是在性能上的大突破，能比前一版PHP 5快上一倍，PHP之父Rasmus Lerdorf表示，甚至能比HHVM虚拟机下的PHP程序性能更快。

### PHP之父：PHP7 性能翻倍关键大揭秘 ###

HHVM 是脸书为自家网站特性而量身客制的PHP优化机制，不见得适用任何网站。但Rasmus Lerdorf表示，新版目标之一就是要让任何网站开发者，就连使用开发框架Drupal、开源电子商务系统Opencart时，都能有不输使用HHVM 技术的性能。在新版发表前夕，他也趁来台参加PHPConf Taiwan年会时，分享PHP 7性能大突破的关键。

一个20年来历经了多 次改版和无数次优化的成熟语言，还能有性能提高一倍的突破绝非易事，Rasmus Lerdorf坦言，不像一般新项目多半容易找出许多改进空间，新版PHP并非修改部分程序就达到了如此的成果。反而是，透过大量细节优化和性能累加 后，PHP 7才具备了不输HHVM的执行性能。

除了从减少内存的使用着手外，Rasmus Lerdorf更检视CPU的Cache line的运作原理，了解程序代码如何与CPU互动、编译程序如何在新CPU架构下编译程序代码等细节，确保PHP 7的程序代码符合现代CPU的架构。虽然每个项目的优化对性能贡献都低于0.5%，但由于优化的项目很多，或是某项改善的功能会被应用程序反复呼叫，整体 修正的综效结果就能有如此大的进展。

### 受HHVM刺激，决定打造兼具性能与功能的PHP ###

Facebook为了优化PHP运作，搭配JIT编译而打造出虚拟机HHVM。而HHVM虽然拥有快速的执行性能，其为特定用途优化的设计，只能满足小部分的开发者。反之，Rasmus Lerdorf除了想提升PHP的性能表现外，也想要同时满足高端使用者以及业余使用者的需求，让PHP 7成为兼备性能表现及通用功能的程序语言。

不使用外挂框架的PHP的运算性能表现都很优异，但是受到外加框架的影响，原本可以在数秒内处理上千个网页要求的 PHP，性能大幅下降，变为只能处理数十个要求。Rasmus Lerdorf表示，在HHVM出现之前，相较于对PHP性能表现的要求，使用者比较在意PHP能否降低网页开发的难度，而这些框架能让开发者的工作变得 比较简单。但是在Facebook推出HHVM后，引出许多重视PHP性能表现的使用者，让Rasmus Lerdorf意识到许多使用者有性能表现的需求。他开始思考如何将HHVM的JIT架构与PHP融合。

Rasmus Lerdorf表示，他不能放弃PHP的主要架构，虽然他们曾经考虑过融合两者，但是，HHVM在使用上有很多的限制。虽然HHVM对Facebook及 许多开发者是非常好的工具，但对于PHP项目来说，HHVM的使用范畴还不够宽广，只能符合Facebook或是Wikipedia等特定项目的需求。

### 非强型别语言的PHP，导入JIT是难上加难 ###

然而，在PHP中加入JIT编译是件非常困难的事情。Rasmus Lerdorf表示，JIT必须学会辨认程序的运作模(Patterns)，例如了解哪些部份为重要的程序代码，并且在程序运作前，预测程序被呼叫的时 机，或是哪些部分的程序会呼叫。

而HHVM为了在使用JIT编译，某种程度上受限了PHP的发展。HHVM的用户 必须清楚宣告变量的性质，但是使用PHP的开发者，可以先宣告没有性质的类别(Class)，后续再指定类别的变量属性。「在没有任何限制下，将JIT加 入PHP是我们要做的事。」他表示，PHP必须顾及Wordpress、Drupal等框架的开发者，不能任意停止对此些框架的支持。故与HHVM相 比，PHP在打造JIT的条件限制更多。

目前，PHP核心贡献者之一的Dmitry Stogov开发一个原型JIT，并且使用某些实验性的应用程序去测试运作。Rasmus Lerdorf表示，如果将此JIT用于执行某些重复性的运算或是循环程序，得以让PHP 7性能又再快上10倍。

----------
